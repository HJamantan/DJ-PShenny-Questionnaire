<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #f4f4f4; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
    #event-details, #new-event-section { margin-top: 20px; }
    .dropdown { margin-top: 20px; }
    .dropdown-btn {
      background-color: #007bff;
      color: white;
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .dropdown-content {
      display: none;
      margin-top: 10px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .show { display: block; }
    input, textarea, button { margin-top: 5px; padding: 5px; width: 100%; }
    button { width: auto; margin-right: 10px; }
    .danger-btn {
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 6px 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1 id="welcome">Welcome</h1>
  
  <h2>Your Events</h2>
  <table id="eventsTable">
    <thead>
      <tr><th>Date</th><th>Time</th><th>Location</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="event-details">
    <h2>Event Details</h2>
    <div id="eventDetailsContent">Select an event to see details</div>
  </div>

  <div class="dropdown">
    <button class="dropdown-btn" onclick="toggleDropdown()">+ Add New Event</button>
    <div id="dropdownContent" class="dropdown-content">
      <h2>New Event</h2>
      <form id="newEventForm">
        <label>Date: <input type="date" id="newDate" required></label><br>
        <label>Time: <input type="time" id="newTime" required></label><br>
        <label>Location: <input type="text" id="newLocation" required></label><br>
        <label>Notes: <textarea id="newNotes"></textarea></label><br>
        <button type="submit">Add Event</button>
      </form>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;
    let activeEventId = null;

    // Toggle dropdown
    function toggleDropdown() {
      document.getElementById("dropdownContent").classList.toggle("show");
    }

    // Load client profile + events
    async function loadClientData() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      currentUser = user;

      // Load profile
      const { data: profile } = await supabase
        .from("profiles")
        .select("name")
        .eq("id", user.id)
        .single();

      const welcome = document.getElementById("welcome");
      if (profile && profile.name) {
        welcome.innerText = "Welcome, " + profile.name;
      } else {
        welcome.innerText = "Welcome, " + user.email;
      }

      loadEvents();
    }

    // Load events list
    async function loadEvents() {
      const { data: events, error } = await supabase
        .from("events")
        .select("*")
        .eq("user_id", currentUser.id);

      if (error) {
        console.error("Error loading events:", error);
        return;
      }

      const tbody = document.querySelector("#eventsTable tbody");
      tbody.innerHTML = "";

      events.forEach(event => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${event.date || ""}</td>
          <td>${event.time || ""}</td>
          <td>${event.location || ""}</td>
        `;
        row.addEventListener("click", () => loadEventDetails(event.id));
        tbody.appendChild(row);
      });
    }

    // Load event details
    async function loadEventDetails(eventId) {
      activeEventId = eventId;
      const content = document.getElementById("eventDetailsContent");
      content.innerHTML = "Loading details...";

      if (!eventId) {
        content.innerHTML = "No event selected.";
        return;
      }

      try {
        const { data, error } = await supabase
          .from("events")
          .select("*")
          .eq("id", eventId)
          .single();

        if (error) throw error;

        content.innerHTML = `
          <p><strong>Date:</strong> <input id="event-date" type="date" value="${data.date || ""}"></p>
          <p><strong>Time:</strong> <input id="event-time" type="time" value="${data.time || ""}"></p>
          <p><strong>Location:</strong> <input id="event-location" type="text" value="${data.location || ""}"></p>
          <p><strong>Notes:</strong> <textarea id="event-notes">${data.notes || ""}</textarea></p>
          <button id="saveEventBtn">Save Changes</button>
          <button class="danger-btn" id="deleteEventBtn">Delete Event</button>
        `;

        // Save changes
        document.getElementById("saveEventBtn").onclick = async () => {
          const updates = {
            date: document.getElementById("event-date").value,
            time: document.getElementById("event-time").value,
            location: document.getElementById("event-location").value,
            notes: document.getElementById("event-notes").value
          };

          const { error: updateError } = await supabase
            .from("events")
            .update(updates)
            .eq("id", eventId);

          if (updateError) {
            alert("Error saving event: " + updateError.message);
          } else {
            alert("Event updated!");
            loadEvents(); // refresh event list
          }
        };

        // Delete event
        document.getElementById("deleteEventBtn").onclick = async () => {
          if (!confirm("Are you sure you want to delete this event?")) return;

          const { error: deleteError } = await supabase
            .from("events")
            .delete()
            .eq("id", eventId);

          if (deleteError) {
            alert("Error deleting event: " + deleteError.message);
          } else {
            alert("Event deleted!");
            content.innerHTML = "Select an event to see details";
            loadEvents();
          }
        };

      } catch (err) {
        console.error("Error in loadEventDetails:", err.message);
        content.innerHTML = "Error loading details.";
      }
    }

    // Add new event
    document.getElementById("newEventForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const newEvent = {
        user_id: currentUser.id,
        date: document.getElementById("newDate").value,
        time: document.getElementById("newTime").value,
        location: document.getElementById("newLocation").value,
        notes: document.getElementById("newNotes").value
      };

      const { error } = await supabase.from("events").insert([newEvent]);

      if (error) {
        alert("Error adding event: " + error.message);
      } else {
        alert("Event added!");
        document.getElementById("newEventForm").reset();
        toggleDropdown(); // close dropdown after submit
        loadEvents();
      }
    });

    // Start
    loadClientData();
  </script>
</body>
</html>
