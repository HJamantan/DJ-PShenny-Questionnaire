<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Client Portal</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadPortal() {
      const { data: { session } } = await supabase.auth.getSession();

      if (!session) {
        alert("You must log in first!");
        window.location.href = "login.html";
        return;
    }

    const user = session.user;
    document.getElementById("welcome").innerText = `Welcome, ${user.email}`;

      // Get client record for this user
      let { data: client, error: clientError } = await supabase
        .from("clients")
        .select("*")
        .eq("auth_user_id", user.id)
        .single();

      if (clientError) {
        console.error(clientError);
        alert("Could not load client profile.");
        return;
      }

      // Show basic client info
      document.getElementById("clientInfo").innerHTML = `
        <p><strong>Name:</strong> ${client.name || "Not set"}</p>
        <p><strong>Phone:</strong> ${client.phone || "Not set"}</p>
        <p><strong>Email:</strong> ${client.email}</p>
      `;

      // Get their events
      let { data: events, error: eventError } = await supabase
        .from("events")
        .select("*")
        .eq("client_id", client.id);

      if (eventError) {
        console.error(eventError);
        alert("Could not load events.");
        return;
      }

      // Display events + details
      let eventList = document.getElementById("eventList");
      eventList.innerHTML = "";

      for (let ev of events) {
        eventList.innerHTML += `
          <h3>${ev.type} â€” ${ev.date} @ ${ev.time}</h3>
          <p><strong>Guests:</strong> ${ev.guest_count || "Not set"}</p>
        `;

        // Get event details
        let { data: details } = await supabase
          .from("event_details")
          .select("*")
          .eq("event_id", ev.id);

        if (details && details.length > 0) {
          let d = details[0];
          eventList.innerHTML += `
            <p><strong>Plan:</strong> ${d.plan || "Not provided"}</p>
            <p><strong>Music:</strong> ${d.music || "Not provided"}</p>
            <p><strong>Equipment:</strong> ${d.equipment || "Not provided"}</p>
            <p><strong>Package:</strong> ${d.package || "Not selected"}</p>
            <hr>
          `;
        }
      }
    }

    loadPortal();
  </script>
</head>
<body>
  <h1 id="welcome">Loading...</h1>

  <h2>General Info</h2>
  <div id="clientInfo">Loading client info...</div>

  <h2>Event Details</h2>
  <div id="eventList">Loading events...</div>
</body>
</html>
