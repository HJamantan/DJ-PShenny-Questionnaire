<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Client Portal</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body>
  <h1>Client Portal</h1>

  <div id="eventList">Loading events...</div>

  <h2>Add New Event</h2>
  <form id="newEventForm">
    <label>Date: <input type="date" id="eventDate" required></label><br>
    <label>Time: <input type="time" id="eventTime" required></label><br>
    <label>Event Type:
      <select id="eventType" required>
        <option value="wedding">Wedding</option>
        <option value="business">Business Event</option>
        <option value="birthday">Birthday</option>
      </select>
    </label><br>
    <label>Guest Count: <input type="number" id="guestCount"></label><br>
    <label>Contact Info: <input type="text" id="contactInfo"></label><br>

    <div id="extraFields"></div>

    <button type="submit">Add Event</button>
  </form>

  <p id="eventStatus"></p>

  <script>
    // === Connect to Supabase ===
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc"; // replace with your anon key
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // === Load events for logged-in user ===
    async function loadEvents() {
      const user = (await supabase.auth.getUser()).data.user;
      if (!user) {
        alert("Please log in first.");
        window.location.href = "index.html";
        return;
      }

      const { data: events, error } = await supabase
        .from("events")
        .select("*")
        .eq("user_id", user.id);

      const eventList = document.getElementById("eventList");
      if (error) {
        console.error("Error loading events:", error);
        eventList.innerText = "Error loading events.";
        return;
      }

      if (!events || events.length === 0) {
        eventList.innerText = "No events found. Add one below!";
        return;
      }

      eventList.innerHTML = "";
      for (let ev of events) {
        eventList.innerHTML += `
          <h3>${ev.type} â€” ${ev.date} @ ${ev.time}</h3>
          <p><strong>Guests:</strong> ${ev.guest_count || "Not set"}</p>
          <p><strong>Contact:</strong> ${ev.contact_info || "Not set"}</p>
          <div id="details-${ev.id}">Loading details...</div>
          <hr>
        `;
        loadEventDetails(ev);
      }
    }

    // === Load details for a single event with edit fields ===
    async function loadEventDetails(event) {
      const eventId = event.id;
      const container = document.getElementById(`details-${eventId}`);
      if (!container) return;

      const { data: details, error } = await supabase
        .from("event_details")
        .select("*")
        .eq("event_id", eventId)
        .single();

      if (error && error.code !== "PGRST116") { // ignore "no rows found"
        console.error("Error in loadEventDetails:", error);
        container.innerText = "Error loading details.";
        return;
      }

      // Pre-fill values (if exist)
      const music = details?.music || "";
      const equipment = details?.equipment || "";
      const pkg = details?.package || "";

      // Editable form
      container.innerHTML = `
        <form id="editForm-${eventId}">
          <label>Music: <input type="text" id="music-${eventId}" value="${music}"></label><br>
          <label>Equipment: <input type="text" id="equipment-${eventId}" value="${equipment}"></label><br>
          <label>Package: <input type="text" id="package-${eventId}" value="${pkg}"></label><br>
          <button type="submit">Save Changes</button>
        </form>
        <p id="status-${eventId}"></p>
      `;

      // Add form handler
      document.getElementById(`editForm-${eventId}`).addEventListener("submit", async (e) => {
        e.preventDefault();
        const updatedDetails = {
          event_id: eventId,
          music: document.getElementById(`music-${eventId}`).value,
          equipment: document.getElementById(`equipment-${eventId}`).value,
          package: document.getElementById(`package-${eventId}`).value,
        };

        // Upsert (insert if missing, update if exists)
        const { error: upsertError } = await supabase
          .from("event_details")
          .upsert(updatedDetails, { onConflict: "event_id" });

        const status = document.getElementById(`status-${eventId}`);
        if (upsertError) {
          console.error("Error updating details:", upsertError);
          status.innerText = "Error saving changes.";
        } else {
          status.innerText = "Changes saved!";
        }
      });
    }

    // === Handle event form submission ===
    document.getElementById("newEventForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = (await supabase.auth.getUser()).data.user;
      if (!user) {
        alert("Not logged in!");
        return;
      }

      // Step 1: insert into events table
      const newEvent = {
        user_id: user.id,
        date: document.getElementById("eventDate").value,
        time: document.getElementById("eventTime").value,
        type: document.getElementById("eventType").value,
        guest_count: document.getElementById("guestCount").value,
        contact_info: document.getElementById("contactInfo").value,
      };

      const { data: eventData, error: eventError } = await supabase
        .from("events")
        .insert([newEvent])
        .select()
        .single();

      const status = document.getElementById("eventStatus");
      if (eventError) {
        console.error("Error adding event:", eventError);
        status.innerText = "Error adding event.";
        return;
      }

      // Step 2: insert empty details row
      const { error: detailsError } = await supabase
        .from("event_details")
        .insert([{ event_id: eventData.id }]);

      if (detailsError) {
        console.error("Error creating details row:", detailsError);
        status.innerText = "Event created, but details missing.";
        return;
      }

      status.innerText = "Event and details created!";
      loadEvents();
    });

    // === Change form fields depending on event type ===
    document.getElementById("eventType").addEventListener("change", (e) => {
      const extraFields = document.getElementById("extraFields");
      const type = e.target.value;
      let html = "";

      if (type === "wedding") {
        html = `
          <label>Wedding Song: <input type="text" id="weddingSong"></label><br>
          <label>Package: <input type="text" id="weddingPackage"></label><br>
        `;
      } else if (type === "business") {
        html = `
          <label>Equipment Needed: <input type="text" id="businessEquipment"></label><br>
          <label>Agenda: <input type="text" id="businessAgenda"></label><br>
        `;
      } else if (type === "birthday") {
        html = `
          <label>Theme: <input type="text" id="birthdayTheme"></label><br>
          <label>Entertainment: <input type="text" id="birthdayEntertainment"></label><br>
        `;
      }

      extraFields.innerHTML = html;
    });

    // === Run on page load ===
    loadEvents();
  </script>
</body>
</html>
