<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Client Portal</title>

  <!-- Load Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentClient = null; // store client record

    async function loadPortal() {
      //  Check session
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError) {
        console.error(sessionError);
        alert("Error checking session");
        return;
      }

      if (!session) {
        alert("You must log in first!");
        window.location.href = "login.html";
        return;
      }

      const user = session.user;
      document.getElementById("welcome").innerText = `Welcome, ${user.email}`;

      // ✅ Get client profile
      let { data: client, error: clientError } = await supabase
        .from("clients")
        .select("*")
        .eq("auth_user_id", user.id)
        .single();

      // ✅ Auto-create client if not found
      if (!client) {
        const { data: newClient, error: insertError } = await supabase
          .from("clients")
          .insert([
            {
              auth_user_id: user.id,
              name: user.email,
              email: user.email
            }
          ])
          .select()
          .single();

        if (insertError) {
          console.error(insertError);
          document.getElementById("clientInfo").innerText = "Error creating profile.";
          return;
        }

        client = newClient;
      }

      currentClient = client; // save for event creation

      // ✅ Show client info
      document.getElementById("clientInfo").innerHTML = `
        <p><strong>Name:</strong> ${client.name || "Not set"}</p>
        <p><strong>Phone:</strong> ${client.phone || "Not set"}</p>
        <p><strong>Email:</strong> ${client.email || "Not set"}</p>
      `;

      // Load events
      loadEvents(client.id);
    }

    async function loadEvents(clientId) {
      let { data: events, error: eventError } = await supabase
        .from("events")
        .select("*")
        .eq("client_id", clientId);

      let eventList = document.getElementById("eventList");
      eventList.innerHTML = "";

      if (eventError) {
        console.error(eventError);
        eventList.innerText = "Could not load events.";
        return;
      }

      if (events.length === 0) {
        eventList.innerHTML = "<p>No events found. Use the form below to add one.</p>";
        return;
      }

      for (let ev of events) {
        eventList.innerHTML += `
          <h3>${ev.type} — ${ev.date} @ ${ev.time}</h3>
          <p><strong>Guests:</strong> ${ev.guest_count || "Not set"}</p>
          <div id="details-${ev.id}">Loading details...</div>
          <hr>
        `;
        loadEventDetails(ev.id);
      }
    }

    async function loadEventDetails(eventId) {
      let container = document.getElementById(`details-${eventId}`);

      let { data: details, error: detailError } = await supabase
        .from("event_details")
        .select("*")
        .eq("event_id", eventId)
        .single();

      if (detailError && detailError.code !== "PGRST116") {
        // ignore "No rows found"
        console.error(detailError);
        container.innerText = "Error loading event details.";
        return;
      }

      // Pre-fill if exists
      let plan = details?.plan || "";
      let music = details?.music || "";
      let equipment = details?.equipment || "";
      let pkg = details?.package || "Basic";

      container.innerHTML = `
        <form id="detailsForm-${eventId}">
          <label>Plan:</label><br>
          <textarea id="plan-${eventId}">${plan}</textarea><br><br>

          <label>Music:</label><br>
          <input type="text" id="music-${eventId}" value="${music}"><br><br>

          <label>Equipment:</label><br>
          <input type="text" id="equipment-${eventId}" value="${equipment}"><br><br>

          <label>Package:</label><br>
          <select id="package-${eventId}">
            <option value="Basic" ${pkg === "Basic" ? "selected" : ""}>Basic</option>
            <option value="Standard" ${pkg === "Standard" ? "selected" : ""}>Standard</option>
            <option value="Premium" ${pkg === "Premium" ? "selected" : ""}>Premium</option>
          </select><br><br>

          <button type="submit">Save Details</button>
        </form>
        <p id="saveStatus-${eventId}"></p>
      `;

      document.getElementById(`detailsForm-${eventId}`).onsubmit = async (e) => {
        e.preventDefault();

        const updated = {
          plan: document.getElementById(`plan-${eventId}`).value,
          music: document.getElementById(`music-${eventId}`).value,
          equipment: document.getElementById(`equipment-${eventId}`).value,
          package: document.getElementById(`package-${eventId}`).value,
          event_id: eventId
        };

        let result;
        if (details) {
          // Update existing
          result = await supabase
            .from("event_details")
            .update(updated)
            .eq("event_id", eventId);
        } else {
          // Insert new
          result = await supabase
            .from("event_details")
            .insert([updated]);
        }

        if (result.error) {
          console.error(result.error);
          document.getElementById(`saveStatus-${eventId}`).innerText = "❌ Error saving details.";
        } else {
          document.getElementById(`saveStatus-${eventId}`).innerText = "✅ Details saved!";
        }
      };
    }

    async function addEvent(e) {
      e.preventDefault();

      if (!currentClient) {
        alert("Client not loaded yet.");
        return;
      }

      const newEvent = {
        client_id: currentClient.id,
        type: document.getElementById("eventType").value,
        date: document.getElementById("eventDate").value,
        time: document.getElementById("eventTime").value,
        guest_count: parseInt(document.getElementById("guestCount").value) || null
      };

      let { data, error } = await supabase
        .from("events")
        .insert([newEvent])
        .select();

      if (error) {
        console.error(error);
        document.getElementById("eventStatus").innerText = "❌ Error adding event.";
      } else {
        document.getElementById("eventStatus").innerText = "✅ Event added!";
        loadEvents(currentClient.id); // refresh list
        document.getElementById("eventForm").reset();
      }
    }

    window.onload = () => {
      loadPortal();
      document.getElementById("eventForm").onsubmit = addEvent;
    };
  </script>
</head>
<body>
  <h1 id="welcome">Loading...</h1>

  <h2>General Info</h2>
  <div id="clientInfo">Loading client info...</div>

  <h2>Event Details</h2>
  <div id="eventList">Loading events...</div>

  <h2>Add New Event</h2>
  <form id="eventForm">
    <label>Type:</label><br>
    <select id="eventType" required>
      <option value="Wedding">Wedding</option>
      <option value="Birthday">Birthday</option>
      <option value="Business">Business Event</option>
      <option value="Other">Other</option>
    </select><br><br>

    <label>Date:</label><br>
    <input type="date" id="eventDate" required><br><br>

    <label>Time:</label><br>
    <input type="time" id="eventTime" required><br><br>

    <label>Guest Count:</label><br>
    <input type="number" id="guestCount"><br><br>

    <button type="submit">Add Event</button>
  </form>

  <p id="eventStatus"></p>
</body>
</html>
