<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Client Portal</title>

  <!-- Load Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function loadPortal() {
      // Check session
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();

      if (sessionError) {
        console.error(sessionError);
        alert("Error checking session");
        return;
      }

      if (!session) {
        alert("You must log in first!");
        window.location.href = "login.html";
        return;
      }

      const user = session.user;
      document.getElementById("welcome").innerText = `Welcome, ${user.email}`;

      //  Get client profile
      let { data: client, error: clientError } = await supabase
        .from("clients")
        .select("*")
        .eq("auth_user_id", user.id)
        .single();

      //  Auto-create client if not found
      if (!client) {
        const { data: newClient, error: insertError } = await supabase
          .from("clients")
          .insert([
            {
              auth_user_id: user.id,
              name: user.email,   // Default to email until they edit
              email: user.email
            }
          ])
          .select()
          .single();

        if (insertError) {
          console.error(insertError);
          document.getElementById("clientInfo").innerText = "Error creating profile.";
          return;
        }

        client = newClient;
      }

      //  Show client info
      document.getElementById("clientInfo").innerHTML = `
        <p><strong>Name:</strong> ${client.name || "Not set"}</p>
        <p><strong>Phone:</strong> ${client.phone || "Not set"}</p>
        <p><strong>Email:</strong> ${client.email || "Not set"}</p>
      `;

      //  Load events
      let { data: events, error: eventError } = await supabase
        .from("events")
        .select("*")
        .eq("client_id", client.id);

      if (eventError) {
        console.error(eventError);
        document.getElementById("eventList").innerText = "Could not load events.";
        return;
      }

      let eventList = document.getElementById("eventList");
      eventList.innerHTML = "";

      if (events.length === 0) {
        eventList.innerHTML = "<p>No events found. You can add one below.</p>";
      }

      for (let ev of events) {
        eventList.innerHTML += `
          <h3>${ev.type} â€” ${ev.date} @ ${ev.time}</h3>
          <p><strong>Guests:</strong> ${ev.guest_count || "Not set"}</p>
        `;

        //  Load event details
        let { data: details, error: detailError } = await supabase
          .from("event_details")
          .select("*")
          .eq("event_id", ev.id);

        if (detailError) {
          console.error(detailError);
          eventList.innerHTML += "<p>Error loading event details.</p>";
          continue;
        }

        if (details && details.length > 0) {
          let d = details[0];
          eventList.innerHTML += `
            <p><strong>Plan:</strong> ${d.plan || "Not provided"}</p>
            <p><strong>Music:</strong> ${d.music || "Not provided"}</p>
            <p><strong>Equipment:</strong> ${d.equipment || "Not provided"}</p>
            <p><strong>Package:</strong> ${d.package || "Not selected"}</p>
            <hr>
          `;
        }
      }
    }

    window.onload = loadPortal;
  </script>
</head>
<body>
  <h1 id="welcome">Loading...</h1>

  <h2>General Info</h2>
  <div id="clientInfo">Loading client info...</div>

  <h2>Event Details</h2>
  <div id="eventList">Loading events...</div>
</body>
</html>
