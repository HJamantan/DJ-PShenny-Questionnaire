<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Portal</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background:#f9f9f9; margin:0; padding:20px; }
    header { background:#4a90e2; color:white; padding:20px; border-radius:10px; text-align:center; margin-bottom:20px; }
    h1 { margin:0; }
    .section { background:white; padding:20px; border-radius:10px; box-shadow:0 4px 8px rgba(0,0,0,0.05); margin-bottom:20px; }
    .event { border:1px solid #ddd; border-radius:8px; padding:15px; margin-bottom:15px; background:#fefefe; }
    input, textarea, select { width:100%; padding:6px; margin:4px 0 10px 0; border:1px solid #ccc; border-radius:5px; font-size:14px; }
    button { background:#4a90e2; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-size:14px; }
    button:hover { background:#357ABD; }
    .small-btn { padding:5px 10px; font-size:13px; }
    #new-event-form { margin-top:15px; display:none; }
    label { font-weight:bold; }
  </style>
</head>
<body>

<header>
  <h1 id="welcome">Welcome</h1>
</header>

<div class="section" id="events-section">
  <h2>Your Events</h2>
  <div id="events-list">Loading events...</div>
</div>

<div class="section" id="new-event-section">
  <button onclick="toggleNewEventForm()">+ Add New Event</button>
  <div id="new-event-form">
    <form id="event-form">
      <label>Date & Time:</label>
      <input type="datetime-local" id="event_date" required><br>

      <label>Event Type:</label>
      <select id="event_type" onchange="showEventDetailsFields()" required>
        <option value="">Select type</option>
        <option value="wedding">Wedding</option>
        <option value="birthday">Birthday</option>
        <option value="business">Business Event</option>
      </select><br>

      <div id="dynamic-fields"></div>

      <label>Guest Count:</label>
      <input type="number" id="guest_count"><br>
      <label>Notes:</label>
      <textarea id="notes"></textarea><br>

      <button type="submit">Save Event</button>
    </form>
  </div>
</div>

<script src="https://unpkg.com/@supabase/supabase-js"></script>
<script>
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  let currentUser = null;

  async function initPortal() {
    const { data: sessionData } = await supabase.auth.getUser();
    if(!sessionData?.user){ window.location.href="login.html"; return; }
    currentUser = sessionData.user;

    // Auto-create client row
    const { data: clientRow } = await supabase
      .from("clients")
      .select("*")
      .eq("auth_user_id", currentUser.id)
      .single();
    if(!clientRow) {
      await supabase.from("clients").insert({ auth_user_id: currentUser.id });
    }

    // Auto-create profile
    const { data: profileData } = await supabase
      .from("profiles")
      .select("*")
      .eq("client_id", currentUser.id)
      .single();
    if(!profileData) {
      await supabase.from("profiles").insert({ client_id: currentUser.id, name: "" });
    }

    // Welcome user by name
    const { data: profile } = await supabase
      .from("profiles")
      .select("name")
      .eq("client_id", currentUser.id)
      .single();
    document.getElementById("welcome").innerText = `Welcome, ${profile?.name || currentUser.email}`;

    // Load events
    loadEvents();

    // Form submit
    document.getElementById("event-form").addEventListener("submit", async (e)=>{
      e.preventDefault();
      await addEvent();
    });
  }

  async function loadEvents() {
    const eventsList = document.getElementById("events-list");
    const { data, error } = await supabase
      .from("events")
      .select("*")
      .eq("client_id", currentUser.id)
      .order("event_date",{ascending:true});
    if(error){ console.error(error); eventsList.innerText="Error loading events."; return; }
    if(!data || data.length===0){ eventsList.innerText="No events yet."; return; }

    eventsList.innerHTML="";
    data.forEach(evt=>{
      const div=document.createElement("div");
      div.className="event";
      div.innerHTML=`
        <label>Date & Time:</label>
        <input type="datetime-local" id="date-${evt.id}" value="${evt.event_date?evt.event_date.replace('Z',''):''}"><br>
        <label>Type:</label>
        <input type="text" id="type-${evt.id}" value="${evt.event_type||''}"><br>
        <label>Guest Count:</label>
        <input type="number" id="guest-${evt.id}" value="${evt.guest_count||''}"><br>
        <label>Notes:</label>
        <textarea id="notes-${evt.id}">${evt.notes||''}</textarea><br>
        <button class="small-btn" onclick="updateEvent('${evt.id}')">Save</button>
        <button class="small-btn" onclick="deleteEvent('${evt.id}')">Delete</button>
      `;
      eventsList.appendChild(div);
    });
  }

  function toggleNewEventForm() {
    const form = document.getElementById("new-event-form");
    form.style.display = form.style.display==="none"?"block":"none";
  }

  function showEventDetailsFields() {
    const type = document.getElementById("event_type").value;
    const container = document.getElementById("dynamic-fields");
    container.innerHTML="";
    if(!type) return;

    let fields = [];
    if(type==="wedding") fields=[{label:"Music",id:"music",type:"textarea"},{label:"Equipment",id:"equipment",type:"textarea"}];
    else if(type==="birthday") fields=[{label:"Cake Details",id:"cake",type:"textarea"}];
    else if(type==="business") fields=[{label:"Topics",id:"topics",type:"textarea"},{label:"Equipment",id:"equipment",type:"textarea"}];

    fields.forEach(f=>{
      const label=document.createElement("label");
      label.textContent=f.label+":";
      container.appendChild(label);
      const input=f.type==="textarea"?document.createElement("textarea"):document.createElement("input");
      input.id=f.id;
      container.appendChild(input);
      container.appendChild(document.createElement("br"));
    });
  }

  async function addEvent() {
    const event_date=document.getElementById("event_date").value;
    const event_type=document.getElementById("event_type").value;
    const guest_count=document.getElementById("guest_count").value;
    const notes=document.getElementById("notes").value;

    const { data: newEvent, error } = await supabase
      .from("events")
      .insert([{ client_id: currentUser.id, event_date, event_type, guest_count, notes }]);
    if(error){ alert("Error adding event"); console.error(error); return; }
    loadEvents();
    toggleNewEventForm();
    document.getElementById("event-form").reset();
  }

  async function updateEvent(id) {
    const event_date=document.getElementById(`date-${id}`).value;
    const event_type=document.getElementById(`type-${id}`).value;
    const guest_count=document.getElementById(`guest-${id}`).value;
    const notes=document.getElementById(`notes-${id}`).value;

    const { error } = await supabase
      .from("events")
      .update({ event_date, event_type, guest_count, notes })
      .eq("id", id);
    if(error){ alert("Error updating event"); console.error(error); return; }
    loadEvents();
  }

  async function deleteEvent(id) {
    const { error } = await supabase
      .from("events")
      .delete()
      .eq("id", id);
    if(error){ alert("Error deleting event"); console.error(error); return; }
    loadEvents();
  }

  initPortal();
</script>

</body>
</html>
