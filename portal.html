<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Client Portal</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .section {
      margin-bottom: 20px;
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    h2 {
      margin-top: 0;
    }
    .loading {
      color: gray;
    }
  </style>
</head>
<body>
  <h1 id="welcome">Welcome</h1>

  <!-- Event List -->
  <div id="events-section" class="section">
    <h2>Your Events</h2>
    <div id="events-list" class="loading">Loading events...</div>
  </div>

  <!-- Add New Event (collapsible) -->
  <div id="new-event-section" class="section">
    <h2>
      <button onclick="toggleNewEventForm()">+ Add New Event</button>
    </h2>
    <div id="new-event-form" style="display:none;">
      <form id="event-form">
        <label>Date & Time: <input type="datetime-local" id="event_date" required></label><br><br>
        <label>Type: <input type="text" id="event_type" required></label><br><br>
        <label>Guest Count: <input type="number" id="guest_count"></label><br><br>
        <label>Notes: <textarea id="notes"></textarea></label><br><br>
        <button type="submit">Save Event</button>
      </form>
    </div>
  </div>

  <!-- Supabase JS client -->
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // Replace with your own project details
    const SUPABASE_URL = "https://aodilhcpmsvbcbnphgwm.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFvZGlsaGNwbXN2YmNibnBoZ3dtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1Mzg0MjQsImV4cCI6MjA3MzExNDQyNH0.z3pNo4APUtcXTrCfWfsNigs4MLQ0CIipjk48VT4micc";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Toggle dropdown for new event
    function toggleNewEventForm() {
      const form = document.getElementById("new-event-form");
      form.style.display = form.style.display === "none" ? "block" : "none";
    }

    // Load events on page load
    document.addEventListener("DOMContentLoaded", async () => {
      const { data: { user }, error } = await supabase.auth.getUser();

      if (error || !user) {
        window.location.href = "login.html"; // redirect if not logged in
        return;
      }

      document.getElementById("welcome").innerText = `Welcome, ${user.email}`;

      loadEvents(user.id);

      document.getElementById("event-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        await addEvent(user.id);
      });
    });

    // Load user's events
    async function loadEvents(userId) {
      const { data, error } = await supabase
        .from("events")
        .select("*")
        .eq("user_id", userId)
        .order("event_date", { ascending: true });

      const eventsList = document.getElementById("events-list");

      if (error) {
        console.error("Error loading events:", error);
        eventsList.innerText = "Error loading events.";
        return;
      }

      if (!data || data.length === 0) {
        eventsList.innerText = "No events yet.";
        return;
      }

      eventsList.innerHTML = "";
      data.forEach(evt => {
        const div = document.createElement("div");
        div.innerHTML = `
          <strong>${evt.event_type}</strong> <br>
          Date: ${evt.event_date} <br>
          Guests: ${evt.guest_count || "N/A"} <br>
          Notes: ${evt.notes || ""} <br>
          <button onclick="deleteEvent(${evt.id})">Delete</button>
          <hr>
        `;
        eventsList.appendChild(div);
      });
    }

    // Add new event
    async function addEvent(userId) {
      const event_date = document.getElementById("event_date").value;
      const event_type = document.getElementById("event_type").value;
      const guest_count = document.getElementById("guest_count").value;
      const notes = document.getElementById("notes").value;

      const { data, error } = await supabase
        .from("events")
        .insert([{ user_id: userId, event_date, event_type, guest_count, notes }]);

      if (error) {
        alert("Error adding event: " + error.message);
        console.error(error);
        return;
      }

      document.getElementById("event-form").reset();
      toggleNewEventForm();
      loadEvents(userId);
    }

    // Delete event
    async function deleteEvent(eventId) {
      const { error } = await supabase
        .from("events")
        .delete()
        .eq("id", eventId);

      if (error) {
        alert("Error deleting event: " + error.message);
        console.error(error);
        return;
      }

      const { data: { user } } = await supabase.auth.getUser();
      loadEvents(user.id);
    }
  </script>
</body>
</html>
